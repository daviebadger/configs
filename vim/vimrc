" *********
" Structure
" *********
"
" * Plugins
"
"   * Initialization
"
"     * CSS
"     * HTML
"     * Python
"     * RST
"
"   * Settings
"
"     * Airline
"     * AutoPairs
"     * CtrlP
"     * FlatColor
"     * GitGutter
"     * NERDCommenter
"     * NERDTree
"     * NERDTreeTabs
"     * Promptline
"     * PythonMode
"     * Riv
"     * Syntastic
"     * Tagbar
"     * UltiSnips
"     * YouCompleteMe
"
" * Vim
"
"   * Clipboard
"   * Folding
"   * Indentation
"   * Search
"   * Swaps
"   * Whitespaces
"   * Window

" Plugins
" =======

" Initialization
" --------------

call plug#begin('~/.vim/plugged')

Plug 'airblade/vim-gitgutter'
Plug 'ctrlpvim/ctrlp.vim'
Plug 'easymotion/vim-easymotion'
Plug 'edkolev/promptline.vim'
Plug 'jiangmiao/auto-pairs', {'commit': '3bd07a4'}
Plug 'jistr/vim-nerdtree-tabs'
Plug 'Konfekt/FastFold'
Plug 'majutsushi/tagbar'
Plug 'MaxSt/FlatColor'
Plug 'scrooloose/nerdcommenter'
Plug 'scrooloose/nerdtree'
Plug 'SirVer/ultisnips'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-surround'
Plug 'valloric/youcompleteme', {'do': 'sudo python3 install.py'}
Plug 'vim-airline/vim-airline'
Plug 'vim-syntastic/syntastic'
Plug 'Xuyuanp/nerdtree-git-plugin'

" CSS
" ^^^

Plug 'ap/vim-css-color'
Plug 'hail2u/vim-css3-syntax'

" HTML
" ^^^^

Plug 'alvan/vim-closetag'
Plug 'mattn/emmet-vim'
Plug 'othree/html5.vim'
Plug 'valloric/matchtagalways'
Plug 'vim-scripts/matchit.zip'

" Python
" ^^^^^^

Plug 'python-mode/python-mode'

" RST
" ^^^

Plug 'Rykka/instantrst'
Plug 'Rykka/riv.vim'

call plug#end()

" Settings
" --------

" Airline
" ^^^^^^^

set laststatus=2

let g:airline#extensions#tabline#enabled = 1

" AutoPairs
" ^^^^^^^^^

let g:AutoPairsShortcutToggle='<F4>'

" CtrlP
" ^^^^^

let g:ctrlp_user_command = ['.git', 'cd %s && git ls-files -co --exclude-standard']

" FlatColor
" ^^^^^^^^^

set termguicolors

colorscheme flatcolor

highlight LineNr ctermfg=253 guifg=#cbe3e7

" GitGutter
" ^^^^^^^^^

set updatetime=250

" NERDCommenter
" ^^^^^^^^^^^^^

let g:NERDDefaultAlign = 'left'

let g:NERDCommentEmptyLines = 1
let g:NERDSpaceDelims = 1
let g:NERDTrimTrailingWhitespace = 1

let g:NERDCustomDelimiters = {'python': { 'left': '#' }}

" NERDTree
" ^^^^^^^^

let NERDTreeRespectWildIgnore = 1
let NERDTreeShowHidden = 1

set wildignore+=build
set wildignore+=dist
set wildignore+=egg-info
set wildignore+=__pycache__
set wildignore+=.git
set wildignore+=.mypy_cache

" open NERDTree if directory specified as argument to Vim

autocmd StdinReadPre * let s:std_in=1
autocmd VimEnter * if argc() == 1 && isdirectory(argv()[0]) && !exists("s:std_in") | exe 'NERDTree' argv()[0] | wincmd p | ene | endif

" NERDTreeTabs
" ^^^^^^^^^^^^

nnoremap <C-m> :NERDTreeFocusToggle<CR>
nnoremap <C-n> :NERDTreeMirrorToggle<CR>

" Promptline
" ^^^^^^^^^^

let g:promptline_powerline_symbols = 0
let g:promptline_preset = {
    \ 'a' : [ promptline#slices#user() ],
    \ 'b' : [ '\w' ],
    \ 'c' : [ promptline#slices#vcs_branch() ],
    \ 'y' : [ promptline#slices#python_virtualenv() ]}

" PythonMode
" ^^^^^^^^^^

let g:pymode_lint = 0
let g:pymode_rope = 0
let g:pymode_virtualenv = 0

" Riv
" ^^^

let g:riv_fold_level = 1
let g:riv_section_levels = '*=-^"'''

" Syntastic
" ^^^^^^^^^

set statusline+=%#warningmsg#
set statusline+=%{SyntasticStatuslineFlag()}
set statusline+=%*

let g:syntastic_always_populate_loc_list = 1
let g:syntastic_auto_loc_list = 1
let g:syntastic_loc_list_height = 5

let g:syntastic_check_on_open = 1
let g:syntastic_check_on_wq = 0

let g:syntastic_html_checkers = ['tidy']
let g:syntastic_markdown_checkers = ['mdl']
let g:syntastic_python_checkers = ['flake8']
let g:syntastic_rst_checkers = ['sphinx']

nnoremap <F3> :SyntasticCheck<CR>
nnoremap <C-X> :SyntasticReset<CR>

" close quick window with buffer at once

cabbrev <silent> bd <C-r>=(getcmdtype()==#':' && getcmdpos()==1 ? 'lclose\|bdelete' : 'bd')<CR>

" Tagbar
" ^^^^^^

nnoremap <F2> :TagbarOpenAutoClose<CR>

" UltiSnips
" ^^^^^^^^^

let g:UltiSnipsExpandTrigger="<C-j>"
let g:UltiSnipsJumpForwardTrigger="<C-l>"
let g:UltiSnipsJumpBackwardTrigger="<C-h>"

let g:UltiSnipsEditSplit="horizontal"
let g:UltiSnipsSnippetsDir="~/.vim/snippets"

" YouCompleteMe
" ^^^^^^^^^^^^^

let g:ycm_autoclose_preview_window_after_insertion = 1
let g:ycm_complete_in_strings = 0
let g:ycm_filetype_whitelist = {'python': 1}
let g:ycm_goto_buffer_command = 'horizontal-split'
let g:ycm_python_binary_path = 'python3'

nnoremap <leader>d :YcmCompleter GetDoc<CR>
nnoremap <leader>g :YcmCompleter GoToDefinitionElseDeclaration<CR>
nnoremap <leader>n :YcmCompleter GoToReferences<CR>

" Vim
" ===

" Clipboard
" ---------

set clipboard=unnamedplus

" Folding
" -------

" no fold closed on start

set foldlevelstart=99

" Indention
" ---------

set expandtab
set smarttab

set shiftwidth=4
set softtabstop=4
set tabstop=4

autocmd Filetype html setlocal shiftwidth=2 softtabstop=2 tabstop=2
autocmd Filetype css setlocal shiftwidth=2 softtabstop=2 tabstop=2
autocmd FileType javascript setlocal shiftwidth=2 softtabstop=2 tabstop=2
autocmd FileType rst setlocal shiftwidth=3 softtabstop=3 tabstop=3
autocmd FileType yaml setlocal shiftwidth=2 softtabstop=2 tabstop=2

" Search
" ------

set hlsearch
set ignorecase
set incsearch
set smartcase

nnoremap <esc> :noh<return><esc>
nnoremap <esc>^[ <esc>^[

" Swaps
" -----

set directory=~/.vim/swaps//

" Whitespaces
" -----------

highlight ExtraWhitespace ctermbg=red guibg=red

match ExtraWhitespace /\s\+$/

autocmd BufWinEnter * match ExtraWhitespace /\s\+$/
autocmd InsertEnter * match ExtraWhitespace /\s\+\%#\@<!$/
autocmd InsertLeave * match ExtraWhitespace /\s\+$/
autocmd BufWinLeave * call clearmatches()

" Window
" ------

set number relativenumber
set colorcolumn=80

set nowrap

set splitbelow
set splitright

autocmd InsertEnter * set norelativenumber
autocmd InsertLeave * set relativenumber
